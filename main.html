<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>UaF Stress Test com Gráficos</title>
    <style>
        #container {
            width: 500px;
            height: 500px;
            overflow: auto;
            border: 1px solid black;
            content-visibility: auto;
            margin-top: 20px;
        }

        .child {
            width: 100%;
            height: 20px;
            background: lightgray;
            margin: 1px 0;
        }

        canvas {
            max-width: 600px;
        }
    </style>
</head>

<body>
    <button onclick="startStressTest()">Start UaF Stress Test</button>
    <div>
        <canvas id="fpsChart"></canvas>
        <canvas id="timeChart"></canvas>
        <canvas id="memChart"></canvas>
    </div>
    <div id="container"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let fpsChart, timeChart, memChart;
        let fpsData = [], timeData = [], memData = [];
        let lastFrameTime = performance.now();
        let iteration = 0;
        const maxIterations = 500;

        function setupCharts() {
            fpsChart = new Chart(document.getElementById('fpsChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'FPS',
                        data: [],
                        borderColor: 'blue',
                        fill: false
                    }]
                },
                options: { scales: { x: { display: false } } }
            });

            timeChart = new Chart(document.getElementById('timeChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tempo Iteração (ms)',
                        data: [],
                        borderColor: 'green',
                        fill: false
                    }]
                },
                options: { scales: { x: { display: false } } }
            });

            memChart = new Chart(document.getElementById('memChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memória JS (MB)',
                        data: [],
                        borderColor: 'red',
                        fill: false
                    }]
                },
                options: { scales: { x: { display: false } } }
            });
        }

        function updateCharts(fps, iterTime, memMB) {
            const maxPoints = 100;

            fpsData.push(fps);
            timeData.push(iterTime);
            memData.push(memMB);

            if (fpsData.length > maxPoints) fpsData.shift();
            if (timeData.length > maxPoints) timeData.shift();
            if (memData.length > maxPoints) memData.shift();

            fpsChart.data.labels = fpsData.map((_, i) => i);
            timeChart.data.labels = timeData.map((_, i) => i);
            memChart.data.labels = memData.map((_, i) => i);

            fpsChart.data.datasets[0].data = fpsData;
            timeChart.data.datasets[0].data = timeData;
            memChart.data.datasets[0].data = memData;

            fpsChart.update();
            timeChart.update();
            memChart.update();
        }

        function startStressTest() {
            const container = document.getElementById('container');
            setupCharts();

            function mutateDOM() {
                const start = performance.now();

                for (let i = 0; i < 500; i++) {
                    const el = document.createElement('div');
                    el.className = 'child';
                    el.textContent = 'Element ' + iteration + '-' + i;

                    el.style.contentVisibility = (i % 2 === 0) ? 'auto' : 'visible';
                    el.style.overflow = (i % 3 === 0) ? 'hidden' : 'auto';
                    el.style.contain = (i % 4 === 0) ? 'paint' : 'none';

                    container.appendChild(el);

                    const h = el.offsetHeight;
                    el.style.height = (h + 1) + 'px';

                    if (i % 5 === 0) {
                        container.removeChild(el);
                    }
                }

                if (iteration % 10 === 0) {
                    container.innerHTML = '';
                }

                let garbage = [];
                for (let j = 0; j < 10000; j++) {
                    garbage.push({ x: Math.random(), y: Math.random(), z: new Array(100).fill(0) });
                }
                garbage = null;

                container.scrollTop = container.scrollHeight;

                const now = performance.now();
                const iterTime = now - start;

                // FPS estimado
                const delta = now - lastFrameTime;
                const fps = 1000 / delta;
                lastFrameTime = now;

                // Memória JS estimada
                let memMB = 0;
                if (performance.memory) {
                    memMB = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
                }

                updateCharts(fps, iterTime, memMB);

                iteration++;

                if (iteration < maxIterations) {
                    requestAnimationFrame(mutateDOM);
                } else {
                    console.log('Stress test completed');
                }
            }

            mutateDOM();
        }
    </script>
</body>

</html>
